{"ast":null,"code":"import _classCallCheck from \"/root/kiali-ui/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/classCallCheck\";\nimport _createClass from \"/root/kiali-ui/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/createClass\";\nimport _inherits from \"/root/kiali-ui/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/inherits\";\nimport _createSuper from \"/root/kiali-ui/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/createSuper\";\nvar _jsxFileName = \"/root/kiali-ui/src/pages/IstioConfigNew/IstioConfigNewPage.tsx\";\nimport * as React from 'react';\nimport { activeNamespacesSelector } from '../../store/Selectors';\nimport { connect } from 'react-redux';\nimport { ActionGroup, Button, Form, FormGroup, TextInput } from '@patternfly/react-core';\nimport { RenderContent } from '../../components/Nav/Page';\nimport { style } from 'typestyle';\nimport GatewayForm, { GATEWAY, GATEWAYS, initGateway, isGatewayStateValid } from './GatewayForm';\nimport SidecarForm, { initSidecar, isSidecarStateValid, SIDECAR, SIDECARS } from './SidecarForm';\nimport { Paths, serverConfig } from '../../config';\nimport { PromisesRegistry } from '../../utils/CancelablePromises';\nimport * as API from '../../services/Api';\nimport * as AlertUtils from '../../utils/AlertUtils';\nimport history from '../../app/History';\nimport { buildAuthorizationPolicy, buildGateway, buildPeerAuthentication, buildRequestAuthentication, buildServiceEntry, buildSidecar } from '../../components/IstioWizards/WizardActions';\nimport { MessageType } from '../../types/MessageCenter';\nimport AuthorizationPolicyForm, { AUTHORIZACION_POLICY, AUTHORIZATION_POLICIES, initAuthorizationPolicy, isAuthorizationPolicyStateValid } from './AuthorizationPolicyForm';\nimport PeerAuthenticationForm, { initPeerAuthentication, isPeerAuthenticationStateValid, PEER_AUTHENTICATION, PEER_AUTHENTICATIONS } from './PeerAuthenticationForm';\nimport RequestAuthenticationForm, { initRequestAuthentication, isRequestAuthenticationStateValid, REQUEST_AUTHENTICATION, REQUEST_AUTHENTICATIONS } from './RequestAuthenticationForm';\nimport { isValidK8SName } from '../../helpers/ValidationHelpers';\nimport DefaultSecondaryMasthead from '../../components/DefaultSecondaryMasthead/DefaultSecondaryMasthead';\nimport { PFColors } from '../../components/Pf/PfColors';\nimport ServiceEntryForm, { initServiceEntry, isServiceEntryValid, SERVICE_ENTRIES, SERVICE_ENTRY } from './ServiceEntryForm';\nvar formPadding = style({\n  padding: '30px 20px 30px 20px'\n});\nvar warningStyle = style({\n  marginLeft: 15,\n  paddingTop: 5,\n  color: PFColors.Red100,\n  textAlign: 'center'\n});\nvar DIC = {\n  AuthorizationPolicy: AUTHORIZATION_POLICIES,\n  Gateway: GATEWAYS,\n  PeerAuthentication: PEER_AUTHENTICATIONS,\n  RequestAuthentication: REQUEST_AUTHENTICATIONS,\n  ServiceEntry: SERVICE_ENTRIES,\n  Sidecar: SIDECARS\n}; // Used in the Istio Config list Actions\n\nexport var NEW_ISTIO_RESOURCE = [{\n  value: AUTHORIZACION_POLICY,\n  label: AUTHORIZACION_POLICY,\n  disabled: false\n}, {\n  value: GATEWAY,\n  label: GATEWAY,\n  disabled: false\n}, {\n  value: PEER_AUTHENTICATION,\n  label: PEER_AUTHENTICATION,\n  disabled: false\n}, {\n  value: REQUEST_AUTHENTICATION,\n  label: REQUEST_AUTHENTICATION,\n  disabled: false\n}, {\n  value: SERVICE_ENTRY,\n  label: SERVICE_ENTRY,\n  disabled: false\n}, {\n  value: SIDECAR,\n  label: SIDECAR,\n  disabled: false\n}];\n\nvar initState = function initState() {\n  return {\n    name: '',\n    istioPermissions: {},\n    authorizationPolicy: initAuthorizationPolicy(),\n    gateway: initGateway(),\n    peerAuthentication: initPeerAuthentication(),\n    requestAuthentication: initRequestAuthentication(),\n    serviceEntry: initServiceEntry(),\n    // Init with the istio-system/* for sidecar\n    sidecar: initSidecar(serverConfig.istioNamespace + '/*')\n  };\n};\n\nvar IstioConfigNewPage = /*#__PURE__*/function (_React$Component) {\n  _inherits(IstioConfigNewPage, _React$Component);\n\n  var _super = _createSuper(IstioConfigNewPage);\n\n  function IstioConfigNewPage(props) {\n    var _this;\n\n    _classCallCheck(this, IstioConfigNewPage);\n\n    _this = _super.call(this, props);\n    _this.promises = new PromisesRegistry();\n\n    _this.canCreate = function (namespace) {\n      return _this.state.istioPermissions[namespace] && _this.props.match.params.objectType.length > 0 && _this.state.istioPermissions[namespace][DIC[_this.props.match.params.objectType]].create;\n    };\n\n    _this.fetchPermissions = function () {\n      if (_this.props.activeNamespaces.length > 0) {\n        _this.promises.register('permissions', API.getIstioPermissions(_this.props.activeNamespaces.map(function (n) {\n          return n.name;\n        }))).then(function (permResponse) {\n          _this.setState({\n            istioPermissions: permResponse.data\n          }, function () {\n            _this.props.activeNamespaces.forEach(function (ns) {\n              if (!_this.canCreate(ns.name)) {\n                AlertUtils.addWarning('User has not permissions to create Istio Config on namespace: ' + ns.name);\n              }\n            });\n          });\n        }).catch(function (error) {\n          // Canceled errors are expected on this query when page is unmounted\n          if (!error.isCanceled) {\n            AlertUtils.addError('Could not fetch Permissions.', error);\n          }\n        });\n      }\n    };\n\n    _this.onNameChange = function (value, _) {\n      _this.setState({\n        name: value\n      });\n    };\n\n    _this.onIstioResourceCreate = function () {\n      var jsonIstioObjects = [];\n\n      _this.props.activeNamespaces.forEach(function (ns) {\n        switch (_this.props.match.params.objectType) {\n          case AUTHORIZACION_POLICY:\n            jsonIstioObjects.push({\n              namespace: ns.name,\n              json: JSON.stringify(buildAuthorizationPolicy(_this.state.name, ns.name, _this.state.authorizationPolicy))\n            });\n            break;\n\n          case GATEWAY:\n            jsonIstioObjects.push({\n              namespace: ns.name,\n              json: JSON.stringify(buildGateway(_this.state.name, ns.name, _this.state.gateway))\n            });\n            break;\n\n          case PEER_AUTHENTICATION:\n            jsonIstioObjects.push({\n              namespace: ns.name,\n              json: JSON.stringify(buildPeerAuthentication(_this.state.name, ns.name, _this.state.peerAuthentication))\n            });\n            break;\n\n          case REQUEST_AUTHENTICATION:\n            jsonIstioObjects.push({\n              namespace: ns.name,\n              json: JSON.stringify(buildRequestAuthentication(_this.state.name, ns.name, _this.state.requestAuthentication))\n            });\n            break;\n\n          case SERVICE_ENTRY:\n            jsonIstioObjects.push({\n              namespace: ns.name,\n              json: JSON.stringify(buildServiceEntry(_this.state.name, ns.name, _this.state.serviceEntry))\n            });\n            break;\n\n          case SIDECAR:\n            jsonIstioObjects.push({\n              namespace: ns.name,\n              json: JSON.stringify(buildSidecar(_this.state.name, ns.name, _this.state.sidecar))\n            });\n            break;\n        }\n      });\n\n      _this.promises.registerAll('Create ' + DIC[_this.props.match.params.objectType], jsonIstioObjects.map(function (o) {\n        return API.createIstioConfigDetail(o.namespace, DIC[_this.props.match.params.objectType], o.json);\n      })).then(function (results) {\n        if (results.length > 0) {\n          AlertUtils.add('Istio ' + _this.props.match.params.objectType + ' created', 'default', MessageType.SUCCESS);\n        }\n\n        _this.backToList();\n      }).catch(function (error) {\n        AlertUtils.addError('Could not create Istio ' + _this.props.match.params.objectType + ' objects.', error);\n      });\n    };\n\n    _this.backToList = function () {\n      _this.setState(initState(), function () {\n        // Back to list page\n        history.push(\"/\".concat(Paths.ISTIO, \"?namespaces=\").concat(_this.props.activeNamespaces.map(function (n) {\n          return n.name;\n        }).join(',')));\n      });\n    };\n\n    _this.isIstioFormValid = function () {\n      switch (_this.props.match.params.objectType) {\n        case AUTHORIZACION_POLICY:\n          return isAuthorizationPolicyStateValid(_this.state.authorizationPolicy);\n\n        case GATEWAY:\n          return isGatewayStateValid(_this.state.gateway);\n\n        case PEER_AUTHENTICATION:\n          return isPeerAuthenticationStateValid(_this.state.peerAuthentication);\n\n        case REQUEST_AUTHENTICATION:\n          return isRequestAuthenticationStateValid(_this.state.requestAuthentication);\n\n        case SERVICE_ENTRY:\n          return isServiceEntryValid(_this.state.serviceEntry);\n\n        case SIDECAR:\n          return isSidecarStateValid(_this.state.sidecar);\n\n        default:\n          return false;\n      }\n    };\n\n    _this.onChangeAuthorizationPolicy = function (authorizationPolicy) {\n      _this.setState(function (prevState) {\n        Object.keys(prevState.authorizationPolicy).forEach(function (key) {\n          return prevState.authorizationPolicy[key] = authorizationPolicy[key];\n        });\n        return {\n          authorizationPolicy: prevState.authorizationPolicy\n        };\n      });\n    };\n\n    _this.onChangeGateway = function (gateway) {\n      _this.setState(function (prevState) {\n        Object.keys(prevState.gateway).forEach(function (key) {\n          return prevState.gateway[key] = gateway[key];\n        });\n        return {\n          gateway: prevState.gateway\n        };\n      });\n    };\n\n    _this.onChangePeerAuthentication = function (peerAuthentication) {\n      _this.setState(function (prevState) {\n        Object.keys(prevState.peerAuthentication).forEach(function (key) {\n          return prevState.peerAuthentication[key] = peerAuthentication[key];\n        });\n        return {\n          peerAuthentication: prevState.peerAuthentication\n        };\n      });\n    };\n\n    _this.onChangeRequestAuthentication = function (requestAuthentication) {\n      _this.setState(function (prevState) {\n        Object.keys(prevState.requestAuthentication).forEach(function (key) {\n          return prevState.requestAuthentication[key] = requestAuthentication[key];\n        });\n        return {\n          requestAuthentication: prevState.requestAuthentication\n        };\n      });\n    };\n\n    _this.onChangeServiceEntry = function (serviceEntry) {\n      _this.setState(function (prevState) {\n        Object.keys(prevState.serviceEntry).forEach(function (key) {\n          return prevState.serviceEntry[key] = serviceEntry[key];\n        });\n        return {\n          serviceEntry: prevState.serviceEntry\n        };\n      });\n    };\n\n    _this.onChangeSidecar = function (sidecar) {\n      _this.setState(function (prevState) {\n        Object.keys(prevState.sidecar).forEach(function (key) {\n          return prevState.sidecar[key] = sidecar[key];\n        });\n        return {\n          sidecar: prevState.sidecar\n        };\n      });\n    };\n\n    _this.state = initState();\n    return _this;\n  }\n\n  _createClass(IstioConfigNewPage, [{\n    key: \"componentWillUnmount\",\n    value: function componentWillUnmount() {\n      this.promises.cancelAll();\n    }\n  }, {\n    key: \"componentDidMount\",\n    value: function componentDidMount() {\n      // Init component state\n      this.setState(Object.assign({}, initState));\n      this.fetchPermissions();\n    }\n  }, {\n    key: \"componentDidUpdate\",\n    value: function componentDidUpdate(prevProps, _prevState) {\n      if (prevProps.activeNamespaces !== this.props.activeNamespaces) {\n        this.fetchPermissions();\n      }\n    }\n  }, {\n    key: \"render\",\n    value: function render() {\n      var _this2 = this;\n\n      var canCreate = this.props.activeNamespaces.every(function (ns) {\n        return _this2.canCreate(ns.name);\n      });\n      var isNameValid = isValidK8SName(this.state.name);\n      var isNamespacesValid = this.props.activeNamespaces.length > 0;\n      var isFormValid = canCreate && isNameValid && isNamespacesValid && this.isIstioFormValid();\n      return /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement(\"div\", {\n        style: {\n          backgroundColor: '#fff'\n        },\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 337,\n          columnNumber: 9\n        }\n      }, /*#__PURE__*/React.createElement(DefaultSecondaryMasthead, {\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 338,\n          columnNumber: 11\n        }\n      })), /*#__PURE__*/React.createElement(RenderContent, {\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 340,\n          columnNumber: 9\n        }\n      }, /*#__PURE__*/React.createElement(Form, {\n        className: formPadding,\n        isHorizontal: true,\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 341,\n          columnNumber: 11\n        }\n      }, /*#__PURE__*/React.createElement(FormGroup, {\n        label: \"Name\",\n        isRequired: true,\n        fieldId: \"name\",\n        helperTextInvalid: 'A valid ' + this.props.match.params.objectType + ' name is required',\n        isValid: isNameValid,\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 342,\n          columnNumber: 13\n        }\n      }, /*#__PURE__*/React.createElement(TextInput, {\n        value: this.state.name,\n        isRequired: true,\n        type: \"text\",\n        id: \"name\",\n        \"aria-describedby\": \"name\",\n        name: \"name\",\n        onChange: this.onNameChange,\n        isValid: isNameValid,\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 349,\n          columnNumber: 15\n        }\n      })), this.props.match.params.objectType === AUTHORIZACION_POLICY && /*#__PURE__*/React.createElement(AuthorizationPolicyForm, {\n        authorizationPolicy: this.state.authorizationPolicy,\n        onChange: this.onChangeAuthorizationPolicy,\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 361,\n          columnNumber: 15\n        }\n      }), this.props.match.params.objectType === GATEWAY && /*#__PURE__*/React.createElement(GatewayForm, {\n        gateway: this.state.gateway,\n        onChange: this.onChangeGateway,\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 367,\n          columnNumber: 15\n        }\n      }), this.props.match.params.objectType === PEER_AUTHENTICATION && /*#__PURE__*/React.createElement(PeerAuthenticationForm, {\n        peerAuthentication: this.state.peerAuthentication,\n        onChange: this.onChangePeerAuthentication,\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 370,\n          columnNumber: 15\n        }\n      }), this.props.match.params.objectType === REQUEST_AUTHENTICATION && /*#__PURE__*/React.createElement(RequestAuthenticationForm, {\n        requestAuthentication: this.state.requestAuthentication,\n        onChange: this.onChangeRequestAuthentication,\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 376,\n          columnNumber: 15\n        }\n      }), this.props.match.params.objectType === SERVICE_ENTRY && /*#__PURE__*/React.createElement(ServiceEntryForm, {\n        serviceEntry: this.state.serviceEntry,\n        onChange: this.onChangeServiceEntry,\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 382,\n          columnNumber: 15\n        }\n      }), this.props.match.params.objectType === SIDECAR && /*#__PURE__*/React.createElement(SidecarForm, {\n        sidecar: this.state.sidecar,\n        onChange: this.onChangeSidecar,\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 385,\n          columnNumber: 15\n        }\n      }), /*#__PURE__*/React.createElement(ActionGroup, {\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 387,\n          columnNumber: 13\n        }\n      }, /*#__PURE__*/React.createElement(Button, {\n        variant: \"primary\",\n        isDisabled: !isFormValid,\n        onClick: function onClick() {\n          return _this2.onIstioResourceCreate();\n        },\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 388,\n          columnNumber: 15\n        }\n      }, \"Create\"), /*#__PURE__*/React.createElement(Button, {\n        variant: \"secondary\",\n        onClick: function onClick() {\n          return _this2.backToList();\n        },\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 391,\n          columnNumber: 15\n        }\n      }, \"Cancel\"), !isNamespacesValid && /*#__PURE__*/React.createElement(\"span\", {\n        className: warningStyle,\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 395,\n          columnNumber: 17\n        }\n      }, \"An Istio Config resource needs at least a namespace selected\")))));\n    }\n  }]);\n\n  return IstioConfigNewPage;\n}(React.Component);\n\nvar mapStateToProps = function mapStateToProps(state) {\n  return {\n    activeNamespaces: activeNamespacesSelector(state)\n  };\n};\n\nvar IstioConfigNewPageContainer = connect(mapStateToProps, null)(IstioConfigNewPage);\nexport default IstioConfigNewPageContainer;","map":{"version":3,"sources":["/root/kiali-ui/src/pages/IstioConfigNew/IstioConfigNewPage.tsx"],"names":["React","activeNamespacesSelector","connect","ActionGroup","Button","Form","FormGroup","TextInput","RenderContent","style","GatewayForm","GATEWAY","GATEWAYS","initGateway","isGatewayStateValid","SidecarForm","initSidecar","isSidecarStateValid","SIDECAR","SIDECARS","Paths","serverConfig","PromisesRegistry","API","AlertUtils","history","buildAuthorizationPolicy","buildGateway","buildPeerAuthentication","buildRequestAuthentication","buildServiceEntry","buildSidecar","MessageType","AuthorizationPolicyForm","AUTHORIZACION_POLICY","AUTHORIZATION_POLICIES","initAuthorizationPolicy","isAuthorizationPolicyStateValid","PeerAuthenticationForm","initPeerAuthentication","isPeerAuthenticationStateValid","PEER_AUTHENTICATION","PEER_AUTHENTICATIONS","RequestAuthenticationForm","initRequestAuthentication","isRequestAuthenticationStateValid","REQUEST_AUTHENTICATION","REQUEST_AUTHENTICATIONS","isValidK8SName","DefaultSecondaryMasthead","PFColors","ServiceEntryForm","initServiceEntry","isServiceEntryValid","SERVICE_ENTRIES","SERVICE_ENTRY","formPadding","padding","warningStyle","marginLeft","paddingTop","color","Red100","textAlign","DIC","AuthorizationPolicy","Gateway","PeerAuthentication","RequestAuthentication","ServiceEntry","Sidecar","NEW_ISTIO_RESOURCE","value","label","disabled","initState","name","istioPermissions","authorizationPolicy","gateway","peerAuthentication","requestAuthentication","serviceEntry","sidecar","istioNamespace","IstioConfigNewPage","props","promises","canCreate","namespace","state","match","params","objectType","length","create","fetchPermissions","activeNamespaces","register","getIstioPermissions","map","n","then","permResponse","setState","data","forEach","ns","addWarning","catch","error","isCanceled","addError","onNameChange","_","onIstioResourceCreate","jsonIstioObjects","push","json","JSON","stringify","registerAll","o","createIstioConfigDetail","results","add","SUCCESS","backToList","ISTIO","join","isIstioFormValid","onChangeAuthorizationPolicy","prevState","Object","keys","key","onChangeGateway","onChangePeerAuthentication","onChangeRequestAuthentication","onChangeServiceEntry","onChangeSidecar","cancelAll","assign","prevProps","_prevState","every","isNameValid","isNamespacesValid","isFormValid","backgroundColor","Component","mapStateToProps","IstioConfigNewPageContainer"],"mappings":"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","sourcesContent":["import * as React from 'react';\nimport { KialiAppState } from '../../store/Store';\nimport { activeNamespacesSelector } from '../../store/Selectors';\nimport { connect } from 'react-redux';\nimport Namespace from '../../types/Namespace';\nimport { ActionGroup, Button, Form, FormGroup, TextInput } from '@patternfly/react-core';\nimport { RenderContent } from '../../components/Nav/Page';\nimport { style } from 'typestyle';\nimport GatewayForm, { GATEWAY, GATEWAYS, GatewayState, initGateway, isGatewayStateValid } from './GatewayForm';\nimport SidecarForm, { initSidecar, isSidecarStateValid, SIDECAR, SIDECARS, SidecarState } from './SidecarForm';\nimport { Paths, serverConfig } from '../../config';\nimport { PromisesRegistry } from '../../utils/CancelablePromises';\nimport * as API from '../../services/Api';\nimport { IstioPermissions } from '../../types/IstioConfigDetails';\nimport * as AlertUtils from '../../utils/AlertUtils';\nimport history from '../../app/History';\nimport {\n  buildAuthorizationPolicy,\n  buildGateway,\n  buildPeerAuthentication,\n  buildRequestAuthentication,\n  buildServiceEntry,\n  buildSidecar\n} from '../../components/IstioWizards/WizardActions';\nimport { MessageType } from '../../types/MessageCenter';\nimport AuthorizationPolicyForm, {\n  AUTHORIZACION_POLICY,\n  AUTHORIZATION_POLICIES,\n  AuthorizationPolicyState,\n  initAuthorizationPolicy,\n  isAuthorizationPolicyStateValid\n} from './AuthorizationPolicyForm';\nimport PeerAuthenticationForm, {\n  initPeerAuthentication,\n  isPeerAuthenticationStateValid,\n  PEER_AUTHENTICATION,\n  PEER_AUTHENTICATIONS,\n  PeerAuthenticationState\n} from './PeerAuthenticationForm';\nimport RequestAuthenticationForm, {\n  initRequestAuthentication,\n  isRequestAuthenticationStateValid,\n  REQUEST_AUTHENTICATION,\n  REQUEST_AUTHENTICATIONS,\n  RequestAuthenticationState\n} from './RequestAuthenticationForm';\nimport { isValidK8SName } from '../../helpers/ValidationHelpers';\nimport DefaultSecondaryMasthead from '../../components/DefaultSecondaryMasthead/DefaultSecondaryMasthead';\nimport { RouteComponentProps } from 'react-router-dom';\nimport { PFColors } from '../../components/Pf/PfColors';\nimport ServiceEntryForm, {\n  initServiceEntry,\n  isServiceEntryValid,\n  SERVICE_ENTRIES,\n  SERVICE_ENTRY,\n  ServiceEntryState\n} from './ServiceEntryForm';\n\nexport interface IstioConfigNewPageId {\n  objectType: string;\n}\n\ntype Props = RouteComponentProps<IstioConfigNewPageId> & {\n  activeNamespaces: Namespace[];\n};\n\ntype State = {\n  name: string;\n  istioPermissions: IstioPermissions;\n  authorizationPolicy: AuthorizationPolicyState;\n  gateway: GatewayState;\n  peerAuthentication: PeerAuthenticationState;\n  requestAuthentication: RequestAuthenticationState;\n  serviceEntry: ServiceEntryState;\n  sidecar: SidecarState;\n};\n\nconst formPadding = style({ padding: '30px 20px 30px 20px' });\n\nconst warningStyle = style({\n  marginLeft: 15,\n  paddingTop: 5,\n  color: PFColors.Red100,\n  textAlign: 'center'\n});\n\nconst DIC = {\n  AuthorizationPolicy: AUTHORIZATION_POLICIES,\n  Gateway: GATEWAYS,\n  PeerAuthentication: PEER_AUTHENTICATIONS,\n  RequestAuthentication: REQUEST_AUTHENTICATIONS,\n  ServiceEntry: SERVICE_ENTRIES,\n  Sidecar: SIDECARS\n};\n\n// Used in the Istio Config list Actions\nexport const NEW_ISTIO_RESOURCE = [\n  { value: AUTHORIZACION_POLICY, label: AUTHORIZACION_POLICY, disabled: false },\n  { value: GATEWAY, label: GATEWAY, disabled: false },\n  { value: PEER_AUTHENTICATION, label: PEER_AUTHENTICATION, disabled: false },\n  { value: REQUEST_AUTHENTICATION, label: REQUEST_AUTHENTICATION, disabled: false },\n  { value: SERVICE_ENTRY, label: SERVICE_ENTRY, disabled: false },\n  { value: SIDECAR, label: SIDECAR, disabled: false }\n];\n\nconst initState = (): State => ({\n  name: '',\n  istioPermissions: {},\n  authorizationPolicy: initAuthorizationPolicy(),\n  gateway: initGateway(),\n  peerAuthentication: initPeerAuthentication(),\n  requestAuthentication: initRequestAuthentication(),\n  serviceEntry: initServiceEntry(),\n  // Init with the istio-system/* for sidecar\n  sidecar: initSidecar(serverConfig.istioNamespace + '/*')\n});\n\nclass IstioConfigNewPage extends React.Component<Props, State> {\n  private promises = new PromisesRegistry();\n\n  constructor(props: Props) {\n    super(props);\n    this.state = initState();\n  }\n\n  componentWillUnmount() {\n    this.promises.cancelAll();\n  }\n\n  componentDidMount() {\n    // Init component state\n    this.setState(Object.assign({}, initState));\n    this.fetchPermissions();\n  }\n\n  componentDidUpdate(prevProps: Props, _prevState: State) {\n    if (prevProps.activeNamespaces !== this.props.activeNamespaces) {\n      this.fetchPermissions();\n    }\n  }\n\n  canCreate = (namespace: string): boolean => {\n    return (\n      this.state.istioPermissions[namespace] &&\n      this.props.match.params.objectType.length > 0 &&\n      this.state.istioPermissions[namespace][DIC[this.props.match.params.objectType]].create\n    );\n  };\n\n  fetchPermissions = () => {\n    if (this.props.activeNamespaces.length > 0) {\n      this.promises\n        .register('permissions', API.getIstioPermissions(this.props.activeNamespaces.map(n => n.name)))\n        .then(permResponse => {\n          this.setState(\n            {\n              istioPermissions: permResponse.data\n            },\n            () => {\n              this.props.activeNamespaces.forEach(ns => {\n                if (!this.canCreate(ns.name)) {\n                  AlertUtils.addWarning('User has not permissions to create Istio Config on namespace: ' + ns.name);\n                }\n              });\n            }\n          );\n        })\n        .catch(error => {\n          // Canceled errors are expected on this query when page is unmounted\n          if (!error.isCanceled) {\n            AlertUtils.addError('Could not fetch Permissions.', error);\n          }\n        });\n    }\n  };\n\n  onNameChange = (value, _) => {\n    this.setState({\n      name: value\n    });\n  };\n\n  onIstioResourceCreate = () => {\n    const jsonIstioObjects: { namespace: string; json: string }[] = [];\n    this.props.activeNamespaces.forEach(ns => {\n      switch (this.props.match.params.objectType) {\n        case AUTHORIZACION_POLICY:\n          jsonIstioObjects.push({\n            namespace: ns.name,\n            json: JSON.stringify(buildAuthorizationPolicy(this.state.name, ns.name, this.state.authorizationPolicy))\n          });\n          break;\n        case GATEWAY:\n          jsonIstioObjects.push({\n            namespace: ns.name,\n            json: JSON.stringify(buildGateway(this.state.name, ns.name, this.state.gateway))\n          });\n          break;\n        case PEER_AUTHENTICATION:\n          jsonIstioObjects.push({\n            namespace: ns.name,\n            json: JSON.stringify(buildPeerAuthentication(this.state.name, ns.name, this.state.peerAuthentication))\n          });\n          break;\n        case REQUEST_AUTHENTICATION:\n          jsonIstioObjects.push({\n            namespace: ns.name,\n            json: JSON.stringify(buildRequestAuthentication(this.state.name, ns.name, this.state.requestAuthentication))\n          });\n          break;\n        case SERVICE_ENTRY:\n          jsonIstioObjects.push({\n            namespace: ns.name,\n            json: JSON.stringify(buildServiceEntry(this.state.name, ns.name, this.state.serviceEntry))\n          });\n          break;\n        case SIDECAR:\n          jsonIstioObjects.push({\n            namespace: ns.name,\n            json: JSON.stringify(buildSidecar(this.state.name, ns.name, this.state.sidecar))\n          });\n          break;\n      }\n    });\n\n    this.promises\n      .registerAll(\n        'Create ' + DIC[this.props.match.params.objectType],\n        jsonIstioObjects.map(o =>\n          API.createIstioConfigDetail(o.namespace, DIC[this.props.match.params.objectType], o.json)\n        )\n      )\n      .then(results => {\n        if (results.length > 0) {\n          AlertUtils.add('Istio ' + this.props.match.params.objectType + ' created', 'default', MessageType.SUCCESS);\n        }\n        this.backToList();\n      })\n      .catch(error => {\n        AlertUtils.addError('Could not create Istio ' + this.props.match.params.objectType + ' objects.', error);\n      });\n  };\n\n  backToList = () => {\n    this.setState(initState(), () => {\n      // Back to list page\n      history.push(`/${Paths.ISTIO}?namespaces=${this.props.activeNamespaces.map(n => n.name).join(',')}`);\n    });\n  };\n\n  isIstioFormValid = (): boolean => {\n    switch (this.props.match.params.objectType) {\n      case AUTHORIZACION_POLICY:\n        return isAuthorizationPolicyStateValid(this.state.authorizationPolicy);\n      case GATEWAY:\n        return isGatewayStateValid(this.state.gateway);\n      case PEER_AUTHENTICATION:\n        return isPeerAuthenticationStateValid(this.state.peerAuthentication);\n      case REQUEST_AUTHENTICATION:\n        return isRequestAuthenticationStateValid(this.state.requestAuthentication);\n      case SERVICE_ENTRY:\n        return isServiceEntryValid(this.state.serviceEntry);\n      case SIDECAR:\n        return isSidecarStateValid(this.state.sidecar);\n      default:\n        return false;\n    }\n  };\n\n  onChangeAuthorizationPolicy = (authorizationPolicy: AuthorizationPolicyState) => {\n    this.setState(prevState => {\n      Object.keys(prevState.authorizationPolicy).forEach(\n        key => (prevState.authorizationPolicy[key] = authorizationPolicy[key])\n      );\n      return {\n        authorizationPolicy: prevState.authorizationPolicy\n      };\n    });\n  };\n\n  onChangeGateway = (gateway: GatewayState) => {\n    this.setState(prevState => {\n      Object.keys(prevState.gateway).forEach(key => (prevState.gateway[key] = gateway[key]));\n      return {\n        gateway: prevState.gateway\n      };\n    });\n  };\n\n  onChangePeerAuthentication = (peerAuthentication: PeerAuthenticationState) => {\n    this.setState(prevState => {\n      Object.keys(prevState.peerAuthentication).forEach(\n        key => (prevState.peerAuthentication[key] = peerAuthentication[key])\n      );\n      return {\n        peerAuthentication: prevState.peerAuthentication\n      };\n    });\n  };\n\n  onChangeRequestAuthentication = (requestAuthentication: RequestAuthenticationState) => {\n    this.setState(prevState => {\n      Object.keys(prevState.requestAuthentication).forEach(\n        key => (prevState.requestAuthentication[key] = requestAuthentication[key])\n      );\n      return {\n        requestAuthentication: prevState.requestAuthentication\n      };\n    });\n  };\n\n  onChangeServiceEntry = (serviceEntry: ServiceEntryState) => {\n    this.setState(prevState => {\n      Object.keys(prevState.serviceEntry).forEach(key => (prevState.serviceEntry[key] = serviceEntry[key]));\n      return {\n        serviceEntry: prevState.serviceEntry\n      };\n    });\n  };\n\n  onChangeSidecar = (sidecar: SidecarState) => {\n    this.setState(prevState => {\n      Object.keys(prevState.sidecar).forEach(key => (prevState.sidecar[key] = sidecar[key]));\n      return {\n        sidecar: prevState.sidecar\n      };\n    });\n  };\n\n  render() {\n    const canCreate = this.props.activeNamespaces.every(ns => this.canCreate(ns.name));\n    const isNameValid = isValidK8SName(this.state.name);\n    const isNamespacesValid = this.props.activeNamespaces.length > 0;\n    const isFormValid = canCreate && isNameValid && isNamespacesValid && this.isIstioFormValid();\n    return (\n      <>\n        <div style={{ backgroundColor: '#fff' }}>\n          <DefaultSecondaryMasthead />\n        </div>\n        <RenderContent>\n          <Form className={formPadding} isHorizontal={true}>\n            <FormGroup\n              label=\"Name\"\n              isRequired={true}\n              fieldId=\"name\"\n              helperTextInvalid={'A valid ' + this.props.match.params.objectType + ' name is required'}\n              isValid={isNameValid}\n            >\n              <TextInput\n                value={this.state.name}\n                isRequired={true}\n                type=\"text\"\n                id=\"name\"\n                aria-describedby=\"name\"\n                name=\"name\"\n                onChange={this.onNameChange}\n                isValid={isNameValid}\n              />\n            </FormGroup>\n            {this.props.match.params.objectType === AUTHORIZACION_POLICY && (\n              <AuthorizationPolicyForm\n                authorizationPolicy={this.state.authorizationPolicy}\n                onChange={this.onChangeAuthorizationPolicy}\n              />\n            )}\n            {this.props.match.params.objectType === GATEWAY && (\n              <GatewayForm gateway={this.state.gateway} onChange={this.onChangeGateway} />\n            )}\n            {this.props.match.params.objectType === PEER_AUTHENTICATION && (\n              <PeerAuthenticationForm\n                peerAuthentication={this.state.peerAuthentication}\n                onChange={this.onChangePeerAuthentication}\n              />\n            )}\n            {this.props.match.params.objectType === REQUEST_AUTHENTICATION && (\n              <RequestAuthenticationForm\n                requestAuthentication={this.state.requestAuthentication}\n                onChange={this.onChangeRequestAuthentication}\n              />\n            )}\n            {this.props.match.params.objectType === SERVICE_ENTRY && (\n              <ServiceEntryForm serviceEntry={this.state.serviceEntry} onChange={this.onChangeServiceEntry} />\n            )}\n            {this.props.match.params.objectType === SIDECAR && (\n              <SidecarForm sidecar={this.state.sidecar} onChange={this.onChangeSidecar} />\n            )}\n            <ActionGroup>\n              <Button variant=\"primary\" isDisabled={!isFormValid} onClick={() => this.onIstioResourceCreate()}>\n                Create\n              </Button>\n              <Button variant=\"secondary\" onClick={() => this.backToList()}>\n                Cancel\n              </Button>\n              {!isNamespacesValid && (\n                <span className={warningStyle}>An Istio Config resource needs at least a namespace selected</span>\n              )}\n            </ActionGroup>\n          </Form>\n        </RenderContent>\n      </>\n    );\n  }\n}\n\nconst mapStateToProps = (state: KialiAppState) => {\n  return {\n    activeNamespaces: activeNamespacesSelector(state)\n  };\n};\n\nconst IstioConfigNewPageContainer = connect(mapStateToProps, null)(IstioConfigNewPage);\n\nexport default IstioConfigNewPageContainer;\n"]},"metadata":{},"sourceType":"module"}