{"ast":null,"code":"import _classCallCheck from \"/root/kiali-ui/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/classCallCheck\";\nimport _createClass from \"/root/kiali-ui/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/createClass\";\nimport _assertThisInitialized from \"/root/kiali-ui/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/assertThisInitialized\";\nimport _inherits from \"/root/kiali-ui/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/inherits\";\nimport _createSuper from \"/root/kiali-ui/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/createSuper\";\nvar _jsxFileName = \"/root/kiali-ui/src/components/IstioWizards/ServiceWizardDropdown.tsx\";\nimport * as React from 'react';\nimport { Button, Dropdown, DropdownGroup, DropdownItem, DropdownPosition, DropdownSeparator, DropdownToggle, Modal, Tooltip, TooltipPosition } from '@patternfly/react-core';\nimport { CaretDownIcon } from '@patternfly/react-icons';\nimport * as AlertUtils from '../../utils/AlertUtils';\nimport * as API from '../../services/Api';\nimport { serverConfig } from '../../config/ServerConfig';\nimport { KIALI_RELATED_LABEL, KIALI_WIZARD_LABEL, SERVICE_WIZARD_ACTIONS, WIZARD_REQUEST_ROUTING, WIZARD_FAULT_INJECTION, WIZARD_TITLES, WIZARD_TRAFFIC_SHIFTING, WIZARD_REQUEST_TIMEOUTS, WIZARD_TCP_TRAFFIC_SHIFTING } from './WizardActions';\nimport ServiceWizard from './ServiceWizard';\nvar DELETE_TRAFFIC_ROUTING = 'delete_traffic_routing';\n\nvar ServiceWizardDropdown = /*#__PURE__*/function (_React$Component) {\n  _inherits(ServiceWizardDropdown, _React$Component);\n\n  var _super = _createSuper(ServiceWizardDropdown);\n\n  function ServiceWizardDropdown(props) {\n    var _this;\n\n    _classCallCheck(this, ServiceWizardDropdown);\n\n    _this = _super.call(this, props);\n    _this.appLabelName = serverConfig.istioLabels.appLabelName;\n    _this.versionLabelName = serverConfig.istioLabels.versionLabelName;\n\n    _this.canCreate = function () {\n      return _this.props.virtualServices.permissions.create && _this.props.destinationRules.permissions.create && !serverConfig.deployment.viewOnlyMode;\n    };\n\n    _this.canUpdate = function () {\n      return _this.props.virtualServices.permissions.update && _this.props.destinationRules.permissions.update && !serverConfig.deployment.viewOnlyMode;\n    };\n\n    _this.canDelete = function () {\n      return _this.props.virtualServices.permissions.delete && _this.props.destinationRules.permissions.delete && !serverConfig.deployment.viewOnlyMode;\n    };\n\n    _this.hasTrafficRouting = function () {\n      return _this.props.virtualServices.items.length > 0 || _this.props.destinationRules.items.length > 0;\n    };\n\n    _this.hasSidecarWorkloads = function () {\n      var hasSidecarWorkloads = false;\n\n      for (var i = 0; i < _this.props.workloads.length; i++) {\n        if (_this.props.workloads[i].istioSidecar) {\n          // At least one workload with sidecar\n          hasSidecarWorkloads = true;\n          break;\n        }\n      }\n\n      return hasSidecarWorkloads;\n    };\n\n    _this.hideConfirmDelete = function () {\n      _this.setState({\n        showConfirmDelete: false\n      });\n    };\n\n    _this.getDeleteMessage = function () {\n      var deleteMessage = 'Are you sure you want to delete ?';\n      var deleteItems = [];\n\n      switch (_this.state.deleteAction) {\n        case DELETE_TRAFFIC_ROUTING:\n          var vsMessage = _this.props.virtualServices.items.length > 0 ? \"VirtualService\".concat(_this.props.virtualServices.items.length > 1 ? 's' : '', \": '\").concat(_this.props.virtualServices.items.map(function (vs) {\n            return vs.metadata.name;\n          }), \"'\") : '';\n          deleteItems.push( /*#__PURE__*/React.createElement(\"div\", {\n            __self: _assertThisInitialized(_this),\n            __source: {\n              fileName: _jsxFileName,\n              lineNumber: 132,\n              columnNumber: 26\n            }\n          }, vsMessage));\n          var drMessage = _this.props.destinationRules.items.length > 0 ? \"DestinationRule\".concat(_this.props.destinationRules.items.length > 1 ? 's' : '', \": '\").concat(_this.props.destinationRules.items.map(function (dr) {\n            return dr.metadata.name;\n          }), \"'\") : '';\n          deleteItems.push( /*#__PURE__*/React.createElement(\"div\", {\n            __self: _assertThisInitialized(_this),\n            __source: {\n              fileName: _jsxFileName,\n              lineNumber: 140,\n              columnNumber: 26\n            }\n          }, drMessage));\n          var paMessage = _this.props.destinationRules.items.length > 0 && _this.hasAnyPeerAuthn(_this.props.destinationRules) ? \"PeerAuthentication\".concat(_this.props.destinationRules.items.length > 1 ? 's' : '', \": '\").concat(_this.props.destinationRules.items.map(function (dr) {\n            return dr.metadata.name;\n          }), \"'\") : '';\n          deleteItems.push( /*#__PURE__*/React.createElement(\"div\", {\n            __self: _assertThisInitialized(_this),\n            __source: {\n              fileName: _jsxFileName,\n              lineNumber: 148,\n              columnNumber: 26\n            }\n          }, paMessage));\n          break;\n\n        default:\n      }\n\n      return /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement(\"div\", {\n        style: {\n          marginBottom: 5\n        },\n        __self: _assertThisInitialized(_this),\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 155,\n          columnNumber: 9\n        }\n      }, deleteMessage), deleteItems);\n    };\n\n    _this.hasAnyPeerAuthn = function (drs) {\n      return drs.items.filter(function (dr) {\n        return !!_this.hasPeerAuthentication(dr);\n      }).length > 0;\n    };\n\n    _this.hasPeerAuthentication = function (dr) {\n      if (!!dr.metadata && !!dr.metadata.annotations && dr.metadata.annotations[KIALI_RELATED_LABEL] !== undefined) {\n        var anno = dr.metadata.annotations[KIALI_RELATED_LABEL];\n        var parts = anno.split('/');\n\n        if (parts.length > 1) {\n          return parts[1];\n        }\n      }\n\n      return '';\n    };\n\n    _this.getValidWorkloads = function () {\n      return _this.props.workloads.filter(function (workload) {\n        // A workload could skip the version label on this check only when there is a single workload list\n        return workload.labels && workload.labels[_this.appLabelName] && (workload.labels[_this.versionLabelName] || _this.props.workloads.length === 1);\n      });\n    };\n\n    _this.getVSWizardLabel = function () {\n      return _this.props.virtualServices.items.length === 1 && _this.props.virtualServices.items[0].metadata.labels && _this.props.virtualServices.items[0].metadata.labels[KIALI_WIZARD_LABEL] ? _this.props.virtualServices.items[0].metadata.labels[KIALI_WIZARD_LABEL] : '';\n    };\n\n    _this.onAction = function (key) {\n      var updateLabel = _this.getVSWizardLabel();\n\n      switch (key) {\n        case WIZARD_REQUEST_ROUTING:\n        case WIZARD_FAULT_INJECTION:\n        case WIZARD_TRAFFIC_SHIFTING:\n        case WIZARD_TCP_TRAFFIC_SHIFTING:\n        case WIZARD_REQUEST_TIMEOUTS:\n          {\n            _this.setState({\n              showWizard: true,\n              wizardType: key,\n              updateWizard: key === updateLabel\n            });\n\n            break;\n          }\n\n        case DELETE_TRAFFIC_ROUTING:\n          {\n            _this.setState({\n              showConfirmDelete: true,\n              deleteAction: key\n            });\n\n            break;\n          }\n\n        default:\n          console.log('Unrecognized key');\n      }\n    };\n\n    _this.onActionsSelect = function () {\n      _this.setState({\n        isActionsOpen: !_this.state.isActionsOpen\n      });\n    };\n\n    _this.onActionsToggle = function (isOpen) {\n      _this.setState({\n        isActionsOpen: isOpen\n      });\n    };\n\n    _this.onClose = function (changed) {\n      _this.setState({\n        showWizard: false\n      });\n\n      if (changed) {\n        _this.props.onChange();\n      }\n    };\n\n    _this.onDelete = function () {\n      _this.setState({\n        isDeleting: true\n      });\n\n      var deletePromises = [];\n\n      switch (_this.state.deleteAction) {\n        case DELETE_TRAFFIC_ROUTING:\n          _this.props.virtualServices.items.forEach(function (vs) {\n            deletePromises.push(API.deleteIstioConfigDetail(vs.metadata.namespace || '', 'virtualservices', vs.metadata.name));\n          });\n\n          _this.props.destinationRules.items.forEach(function (dr) {\n            deletePromises.push(API.deleteIstioConfigDetail(dr.metadata.namespace || '', 'destinationrules', dr.metadata.name));\n\n            var paName = _this.hasPeerAuthentication(dr);\n\n            if (!!paName) {\n              deletePromises.push(API.deleteIstioConfigDetail(dr.metadata.namespace || '', 'peerauthentications', paName));\n            }\n          });\n\n          break;\n      } // For slow scenarios, dialog is hidden and Delete All action blocked until promises have finished\n\n\n      _this.hideConfirmDelete();\n\n      Promise.all(deletePromises).then(function (_results) {\n        _this.setState({\n          isDeleting: false\n        });\n\n        _this.props.onChange();\n      }).catch(function (error) {\n        AlertUtils.addError('Could not delete Istio config objects.', error);\n\n        _this.setState({\n          isDeleting: false\n        });\n      });\n    };\n\n    _this.renderTooltip = function (key, position, msg, child) {\n      return /*#__PURE__*/React.createElement(Tooltip, {\n        key: 'tooltip_' + key,\n        position: position,\n        content: /*#__PURE__*/React.createElement(React.Fragment, null, msg),\n        __self: _assertThisInitialized(_this),\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 280,\n          columnNumber: 7\n        }\n      }, /*#__PURE__*/React.createElement(\"div\", {\n        style: {\n          display: 'inline-block',\n          cursor: 'not-allowed'\n        },\n        __self: _assertThisInitialized(_this),\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 281,\n          columnNumber: 9\n        }\n      }, child));\n    };\n\n    _this.getDropdownItemTooltipMessage = function () {\n      if (serverConfig.deployment.viewOnlyMode) {\n        return 'User has not permissions';\n      } else if (_this.hasTrafficRouting()) {\n        return 'Traffic routing already exists for this service';\n      } else {\n        return \"Traffic routing doesn't exists for this service\";\n      }\n    };\n\n    _this.renderDropdownItem = function (eventKey, updateLabel) {\n      switch (eventKey) {\n        case WIZARD_REQUEST_ROUTING:\n        case WIZARD_FAULT_INJECTION:\n        case WIZARD_TRAFFIC_SHIFTING:\n        case WIZARD_TCP_TRAFFIC_SHIFTING:\n        case WIZARD_REQUEST_TIMEOUTS:\n          // An Item is rendered under two conditions:\n          // a) No traffic -> Wizard can create new one\n          // b) Existing traffic generated by the traffic -> Wizard can update that scenario\n          // Otherwise, the item should be disabled\n          var enabledItem = (_this.canCreate() || _this.canUpdate()) && (!_this.hasTrafficRouting() || _this.hasTrafficRouting() && updateLabel === eventKey);\n          var wizardItem = /*#__PURE__*/React.createElement(DropdownItem, {\n            key: eventKey,\n            component: \"button\",\n            isDisabled: !enabledItem,\n            onClick: function onClick() {\n              return _this.onAction(eventKey);\n            },\n            __self: _assertThisInitialized(_this),\n            __source: {\n              fileName: _jsxFileName,\n              lineNumber: 311,\n              columnNumber: 11\n            }\n          }, WIZARD_TITLES[eventKey]);\n          return !enabledItem ? _this.renderTooltip(eventKey, TooltipPosition.left, _this.getDropdownItemTooltipMessage(), wizardItem) : wizardItem;\n\n        case DELETE_TRAFFIC_ROUTING:\n          var deleteItem = /*#__PURE__*/React.createElement(DropdownItem, {\n            key: eventKey,\n            component: \"button\",\n            onClick: function onClick() {\n              return _this.onAction(eventKey);\n            },\n            isDisabled: !_this.canDelete() || !_this.hasTrafficRouting() || _this.state.isDeleting,\n            __self: _assertThisInitialized(_this),\n            __source: {\n              fileName: _jsxFileName,\n              lineNumber: 325,\n              columnNumber: 11\n            }\n          }, \"Delete Traffic Routing\");\n          return !_this.hasTrafficRouting() ? _this.renderTooltip(eventKey, TooltipPosition.left, _this.getDropdownItemTooltipMessage(), deleteItem) : deleteItem;\n\n        default:\n          return /*#__PURE__*/React.createElement(React.Fragment, null, \"Unsupported\");\n      }\n    };\n\n    _this.renderDropdownItems = function () {\n      var items = [];\n\n      var updateLabel = _this.getVSWizardLabel();\n\n      items = [/*#__PURE__*/React.createElement(DropdownGroup, {\n        key: 'group_create',\n        label: updateLabel === '' ? 'Create' : 'Update',\n        className: \"kiali-group-menu\",\n        children: SERVICE_WIZARD_ACTIONS.map(function (action) {\n          return _this.renderDropdownItem(action, updateLabel);\n        }),\n        __self: _assertThisInitialized(_this),\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 346,\n          columnNumber: 7\n        }\n      })];\n      items.push( /*#__PURE__*/React.createElement(DropdownSeparator, {\n        key: \"actions_separator\",\n        __self: _assertThisInitialized(_this),\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 353,\n          columnNumber: 16\n        }\n      }));\n      items.push(_this.renderDropdownItem(DELETE_TRAFFIC_ROUTING, ''));\n      return items;\n    };\n\n    _this.state = {\n      showWizard: props.show,\n      wizardType: '',\n      showConfirmDelete: false,\n      deleteAction: '',\n      isDeleting: false,\n      updateWizard: false,\n      isActionsOpen: false\n    };\n    return _this;\n  }\n\n  _createClass(ServiceWizardDropdown, [{\n    key: \"render\",\n    value: function render() {\n      var hasSidecarWorkloads = this.hasSidecarWorkloads();\n      var toolTipMsgActions = !hasSidecarWorkloads ? 'There are not Workloads with sidecar for this service' : 'There are not Workloads with ' + this.appLabelName + ' and ' + this.versionLabelName + ' labels';\n      var validWorkloads = this.getValidWorkloads();\n      var validActions = hasSidecarWorkloads && validWorkloads;\n      var dropdown = /*#__PURE__*/React.createElement(Dropdown, {\n        position: DropdownPosition.right,\n        onSelect: this.onActionsSelect,\n        toggle: /*#__PURE__*/React.createElement(DropdownToggle, {\n          onToggle: this.onActionsToggle,\n          iconComponent: CaretDownIcon,\n          __self: this,\n          __source: {\n            fileName: _jsxFileName,\n            lineNumber: 371,\n            columnNumber: 11\n          }\n        }, \"Actions\"),\n        isOpen: this.state.isActionsOpen,\n        dropdownItems: this.renderDropdownItems(),\n        disabled: !validActions,\n        style: {\n          pointerEvents: validActions ? 'auto' : 'none'\n        },\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 367,\n          columnNumber: 7\n        }\n      });\n      return /*#__PURE__*/React.createElement(React.Fragment, null, !hasSidecarWorkloads ? this.renderTooltip('tooltip_wizard_actions', TooltipPosition.top, toolTipMsgActions, dropdown) : dropdown, /*#__PURE__*/React.createElement(ServiceWizard, {\n        show: this.state.showWizard,\n        type: this.state.wizardType,\n        update: this.state.updateWizard,\n        namespace: this.props.namespace,\n        serviceName: this.props.serviceName,\n        workloads: validWorkloads,\n        virtualServices: this.props.virtualServices,\n        destinationRules: this.props.destinationRules,\n        gateways: this.props.gateways,\n        peerAuthentications: this.props.peerAuthentications,\n        tlsStatus: this.props.tlsStatus,\n        onClose: this.onClose,\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 386,\n          columnNumber: 9\n        }\n      }), /*#__PURE__*/React.createElement(Modal, {\n        isSmall: true,\n        title: \"Confirm Delete Traffic Routing ?\",\n        isOpen: this.state.showConfirmDelete,\n        onClose: this.hideConfirmDelete,\n        actions: [/*#__PURE__*/React.createElement(Button, {\n          key: \"cancel\",\n          variant: \"secondary\",\n          onClick: this.hideConfirmDelete,\n          __self: this,\n          __source: {\n            fileName: _jsxFileName,\n            lineNumber: 406,\n            columnNumber: 13\n          }\n        }, \"Cancel\"), /*#__PURE__*/React.createElement(Button, {\n          key: \"confirm\",\n          variant: \"danger\",\n          onClick: this.onDelete,\n          __self: this,\n          __source: {\n            fileName: _jsxFileName,\n            lineNumber: 409,\n            columnNumber: 13\n          }\n        }, \"Delete\")],\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 400,\n          columnNumber: 9\n        }\n      }, this.getDeleteMessage()));\n    }\n  }]);\n\n  return ServiceWizardDropdown;\n}(React.Component);\n\nexport default ServiceWizardDropdown;","map":{"version":3,"sources":["/root/kiali-ui/src/components/IstioWizards/ServiceWizardDropdown.tsx"],"names":["React","Button","Dropdown","DropdownGroup","DropdownItem","DropdownPosition","DropdownSeparator","DropdownToggle","Modal","Tooltip","TooltipPosition","CaretDownIcon","AlertUtils","API","serverConfig","KIALI_RELATED_LABEL","KIALI_WIZARD_LABEL","SERVICE_WIZARD_ACTIONS","WIZARD_REQUEST_ROUTING","WIZARD_FAULT_INJECTION","WIZARD_TITLES","WIZARD_TRAFFIC_SHIFTING","WIZARD_REQUEST_TIMEOUTS","WIZARD_TCP_TRAFFIC_SHIFTING","ServiceWizard","DELETE_TRAFFIC_ROUTING","ServiceWizardDropdown","props","appLabelName","istioLabels","versionLabelName","canCreate","virtualServices","permissions","create","destinationRules","deployment","viewOnlyMode","canUpdate","update","canDelete","delete","hasTrafficRouting","items","length","hasSidecarWorkloads","i","workloads","istioSidecar","hideConfirmDelete","setState","showConfirmDelete","getDeleteMessage","deleteMessage","deleteItems","state","deleteAction","vsMessage","map","vs","metadata","name","push","drMessage","dr","paMessage","hasAnyPeerAuthn","marginBottom","drs","filter","hasPeerAuthentication","annotations","undefined","anno","parts","split","getValidWorkloads","workload","labels","getVSWizardLabel","onAction","key","updateLabel","showWizard","wizardType","updateWizard","console","log","onActionsSelect","isActionsOpen","onActionsToggle","isOpen","onClose","changed","onChange","onDelete","isDeleting","deletePromises","forEach","deleteIstioConfigDetail","namespace","paName","Promise","all","then","_results","catch","error","addError","renderTooltip","position","msg","child","display","cursor","getDropdownItemTooltipMessage","renderDropdownItem","eventKey","enabledItem","wizardItem","left","deleteItem","renderDropdownItems","action","show","toolTipMsgActions","validWorkloads","validActions","dropdown","right","pointerEvents","top","serviceName","gateways","peerAuthentications","tlsStatus","Component"],"mappings":"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","sourcesContent":["import * as React from 'react';\nimport {\n  Button,\n  Dropdown,\n  DropdownGroup,\n  DropdownItem,\n  DropdownPosition,\n  DropdownSeparator,\n  DropdownToggle,\n  Modal,\n  Tooltip,\n  TooltipPosition\n} from '@patternfly/react-core';\nimport { CaretDownIcon } from '@patternfly/react-icons';\nimport { WorkloadOverview } from '../../types/ServiceInfo';\nimport { DestinationRule, DestinationRules, PeerAuthentication, VirtualServices } from '../../types/IstioObjects';\nimport * as AlertUtils from '../../utils/AlertUtils';\nimport * as API from '../../services/Api';\nimport { serverConfig } from '../../config/ServerConfig';\nimport { TLSStatus } from '../../types/TLSStatus';\nimport {\n  KIALI_RELATED_LABEL,\n  KIALI_WIZARD_LABEL,\n  SERVICE_WIZARD_ACTIONS,\n  WIZARD_REQUEST_ROUTING,\n  WIZARD_FAULT_INJECTION,\n  WIZARD_TITLES,\n  WIZARD_TRAFFIC_SHIFTING,\n  WIZARD_REQUEST_TIMEOUTS,\n  WIZARD_TCP_TRAFFIC_SHIFTING\n} from './WizardActions';\nimport ServiceWizard from './ServiceWizard';\n\ntype Props = {\n  namespace: string;\n  serviceName: string;\n  show: boolean;\n  workloads: WorkloadOverview[];\n  virtualServices: VirtualServices;\n  destinationRules: DestinationRules;\n  gateways: string[];\n  peerAuthentications: PeerAuthentication[];\n  tlsStatus?: TLSStatus;\n  onChange: () => void;\n};\n\ntype State = {\n  showWizard: boolean;\n  updateWizard: boolean;\n  wizardType: string;\n  showConfirmDelete: boolean;\n  deleteAction: string;\n  isDeleting: boolean;\n  isActionsOpen: boolean;\n};\n\nconst DELETE_TRAFFIC_ROUTING = 'delete_traffic_routing';\n\nclass ServiceWizardDropdown extends React.Component<Props, State> {\n  constructor(props: Props) {\n    super(props);\n    this.state = {\n      showWizard: props.show,\n      wizardType: '',\n      showConfirmDelete: false,\n      deleteAction: '',\n      isDeleting: false,\n      updateWizard: false,\n      isActionsOpen: false\n    };\n  }\n\n  private appLabelName = serverConfig.istioLabels.appLabelName;\n  private versionLabelName = serverConfig.istioLabels.versionLabelName;\n\n  // Wizard can be opened when there are not existing VS & DR and there are update permissions\n  canCreate = () => {\n    return (\n      this.props.virtualServices.permissions.create &&\n      this.props.destinationRules.permissions.create &&\n      !serverConfig.deployment.viewOnlyMode\n    );\n  };\n\n  canUpdate = () => {\n    return (\n      this.props.virtualServices.permissions.update &&\n      this.props.destinationRules.permissions.update &&\n      !serverConfig.deployment.viewOnlyMode\n    );\n  };\n\n  canDelete = () => {\n    return (\n      this.props.virtualServices.permissions.delete &&\n      this.props.destinationRules.permissions.delete &&\n      !serverConfig.deployment.viewOnlyMode\n    );\n  };\n\n  hasTrafficRouting = () => {\n    return this.props.virtualServices.items.length > 0 || this.props.destinationRules.items.length > 0;\n  };\n\n  hasSidecarWorkloads = (): boolean => {\n    let hasSidecarWorkloads = false;\n    for (let i = 0; i < this.props.workloads.length; i++) {\n      if (this.props.workloads[i].istioSidecar) {\n        // At least one workload with sidecar\n        hasSidecarWorkloads = true;\n        break;\n      }\n    }\n    return hasSidecarWorkloads;\n  };\n\n  hideConfirmDelete = () => {\n    this.setState({ showConfirmDelete: false });\n  };\n\n  getDeleteMessage = () => {\n    const deleteMessage = 'Are you sure you want to delete ?';\n    const deleteItems: JSX.Element[] = [];\n    switch (this.state.deleteAction) {\n      case DELETE_TRAFFIC_ROUTING:\n        let vsMessage =\n          this.props.virtualServices.items.length > 0\n            ? `VirtualService${\n                this.props.virtualServices.items.length > 1 ? 's' : ''\n              }: '${this.props.virtualServices.items.map(vs => vs.metadata.name)}'`\n            : '';\n        deleteItems.push(<div>{vsMessage}</div>);\n\n        let drMessage =\n          this.props.destinationRules.items.length > 0\n            ? `DestinationRule${\n                this.props.destinationRules.items.length > 1 ? 's' : ''\n              }: '${this.props.destinationRules.items.map(dr => dr.metadata.name)}'`\n            : '';\n        deleteItems.push(<div>{drMessage}</div>);\n\n        let paMessage =\n          this.props.destinationRules.items.length > 0 && this.hasAnyPeerAuthn(this.props.destinationRules)\n            ? `PeerAuthentication${\n                this.props.destinationRules.items.length > 1 ? 's' : ''\n              }: '${this.props.destinationRules.items.map(dr => dr.metadata.name)}'`\n            : '';\n        deleteItems.push(<div>{paMessage}</div>);\n\n        break;\n      default:\n    }\n    return (\n      <>\n        <div style={{ marginBottom: 5 }}>{deleteMessage}</div>\n        {deleteItems}\n      </>\n    );\n  };\n\n  hasAnyPeerAuthn = (drs: DestinationRules): boolean => {\n    return drs.items.filter(dr => !!this.hasPeerAuthentication(dr)).length > 0;\n  };\n\n  hasPeerAuthentication = (dr: DestinationRule): string => {\n    if (!!dr.metadata && !!dr.metadata.annotations && dr.metadata.annotations[KIALI_RELATED_LABEL] !== undefined) {\n      const anno = dr.metadata.annotations[KIALI_RELATED_LABEL];\n      const parts = anno.split('/');\n      if (parts.length > 1) {\n        return parts[1];\n      }\n    }\n    return '';\n  };\n\n  getValidWorkloads = (): WorkloadOverview[] => {\n    return this.props.workloads.filter(workload => {\n      // A workload could skip the version label on this check only when there is a single workload list\n      return (\n        workload.labels &&\n        workload.labels[this.appLabelName] &&\n        (workload.labels[this.versionLabelName] || this.props.workloads.length === 1)\n      );\n    });\n  };\n\n  getVSWizardLabel = () => {\n    return this.props.virtualServices.items.length === 1 &&\n      this.props.virtualServices.items[0].metadata.labels &&\n      this.props.virtualServices.items[0].metadata.labels[KIALI_WIZARD_LABEL]\n      ? this.props.virtualServices.items[0].metadata.labels[KIALI_WIZARD_LABEL]\n      : '';\n  };\n\n  onAction = (key: string) => {\n    const updateLabel = this.getVSWizardLabel();\n    switch (key) {\n      case WIZARD_REQUEST_ROUTING:\n      case WIZARD_FAULT_INJECTION:\n      case WIZARD_TRAFFIC_SHIFTING:\n      case WIZARD_TCP_TRAFFIC_SHIFTING:\n      case WIZARD_REQUEST_TIMEOUTS: {\n        this.setState({ showWizard: true, wizardType: key, updateWizard: key === updateLabel });\n        break;\n      }\n      case DELETE_TRAFFIC_ROUTING: {\n        this.setState({ showConfirmDelete: true, deleteAction: key });\n        break;\n      }\n      default:\n        console.log('Unrecognized key');\n    }\n  };\n\n  onActionsSelect = () => {\n    this.setState({\n      isActionsOpen: !this.state.isActionsOpen\n    });\n  };\n\n  onActionsToggle = (isOpen: boolean) => {\n    this.setState({\n      isActionsOpen: isOpen\n    });\n  };\n\n  onClose = (changed: boolean) => {\n    this.setState({ showWizard: false });\n    if (changed) {\n      this.props.onChange();\n    }\n  };\n\n  onDelete = () => {\n    this.setState({\n      isDeleting: true\n    });\n    const deletePromises: Promise<any>[] = [];\n    switch (this.state.deleteAction) {\n      case DELETE_TRAFFIC_ROUTING:\n        this.props.virtualServices.items.forEach(vs => {\n          deletePromises.push(\n            API.deleteIstioConfigDetail(vs.metadata.namespace || '', 'virtualservices', vs.metadata.name)\n          );\n        });\n        this.props.destinationRules.items.forEach(dr => {\n          deletePromises.push(\n            API.deleteIstioConfigDetail(dr.metadata.namespace || '', 'destinationrules', dr.metadata.name)\n          );\n\n          const paName = this.hasPeerAuthentication(dr);\n          if (!!paName) {\n            deletePromises.push(\n              API.deleteIstioConfigDetail(dr.metadata.namespace || '', 'peerauthentications', paName)\n            );\n          }\n        });\n\n        break;\n    }\n    // For slow scenarios, dialog is hidden and Delete All action blocked until promises have finished\n    this.hideConfirmDelete();\n    Promise.all(deletePromises)\n      .then(_results => {\n        this.setState({\n          isDeleting: false\n        });\n        this.props.onChange();\n      })\n      .catch(error => {\n        AlertUtils.addError('Could not delete Istio config objects.', error);\n        this.setState({\n          isDeleting: false\n        });\n      });\n  };\n\n  renderTooltip = (key, position, msg, child): JSX.Element => {\n    return (\n      <Tooltip key={'tooltip_' + key} position={position} content={<>{msg}</>}>\n        <div style={{ display: 'inline-block', cursor: 'not-allowed' }}>{child}</div>\n      </Tooltip>\n    );\n  };\n\n  getDropdownItemTooltipMessage = (): string => {\n    if (serverConfig.deployment.viewOnlyMode) {\n      return 'User has not permissions';\n    } else if (this.hasTrafficRouting()) {\n      return 'Traffic routing already exists for this service';\n    } else {\n      return \"Traffic routing doesn't exists for this service\";\n    }\n  };\n\n  renderDropdownItem = (eventKey: string, updateLabel: string) => {\n    switch (eventKey) {\n      case WIZARD_REQUEST_ROUTING:\n      case WIZARD_FAULT_INJECTION:\n      case WIZARD_TRAFFIC_SHIFTING:\n      case WIZARD_TCP_TRAFFIC_SHIFTING:\n      case WIZARD_REQUEST_TIMEOUTS:\n        // An Item is rendered under two conditions:\n        // a) No traffic -> Wizard can create new one\n        // b) Existing traffic generated by the traffic -> Wizard can update that scenario\n        // Otherwise, the item should be disabled\n        const enabledItem =\n          (this.canCreate() || this.canUpdate()) &&\n          (!this.hasTrafficRouting() || (this.hasTrafficRouting() && updateLabel === eventKey));\n        const wizardItem = (\n          <DropdownItem\n            key={eventKey}\n            component=\"button\"\n            isDisabled={!enabledItem}\n            onClick={() => this.onAction(eventKey)}\n          >\n            {WIZARD_TITLES[eventKey]}\n          </DropdownItem>\n        );\n        return !enabledItem\n          ? this.renderTooltip(eventKey, TooltipPosition.left, this.getDropdownItemTooltipMessage(), wizardItem)\n          : wizardItem;\n      case DELETE_TRAFFIC_ROUTING:\n        const deleteItem = (\n          <DropdownItem\n            key={eventKey}\n            component=\"button\"\n            onClick={() => this.onAction(eventKey)}\n            isDisabled={!this.canDelete() || !this.hasTrafficRouting() || this.state.isDeleting}\n          >\n            Delete Traffic Routing\n          </DropdownItem>\n        );\n        return !this.hasTrafficRouting()\n          ? this.renderTooltip(eventKey, TooltipPosition.left, this.getDropdownItemTooltipMessage(), deleteItem)\n          : deleteItem;\n      default:\n        return <>Unsupported</>;\n    }\n  };\n\n  renderDropdownItems = () => {\n    var items: any[] = [];\n    const updateLabel = this.getVSWizardLabel();\n    items = [\n      <DropdownGroup\n        key={'group_create'}\n        label={updateLabel === '' ? 'Create' : 'Update'}\n        className=\"kiali-group-menu\"\n        children={SERVICE_WIZARD_ACTIONS.map(action => this.renderDropdownItem(action, updateLabel))}\n      />\n    ];\n    items.push(<DropdownSeparator key=\"actions_separator\" />);\n    items.push(this.renderDropdownItem(DELETE_TRAFFIC_ROUTING, ''));\n    return items;\n  };\n\n  render() {\n    const hasSidecarWorkloads = this.hasSidecarWorkloads();\n    const toolTipMsgActions = !hasSidecarWorkloads\n      ? 'There are not Workloads with sidecar for this service'\n      : 'There are not Workloads with ' + this.appLabelName + ' and ' + this.versionLabelName + ' labels';\n    const validWorkloads = this.getValidWorkloads();\n    const validActions = hasSidecarWorkloads && validWorkloads;\n\n    const dropdown = (\n      <Dropdown\n        position={DropdownPosition.right}\n        onSelect={this.onActionsSelect}\n        toggle={\n          <DropdownToggle onToggle={this.onActionsToggle} iconComponent={CaretDownIcon}>\n            Actions\n          </DropdownToggle>\n        }\n        isOpen={this.state.isActionsOpen}\n        dropdownItems={this.renderDropdownItems()}\n        disabled={!validActions}\n        style={{ pointerEvents: validActions ? 'auto' : 'none' }}\n      />\n    );\n    return (\n      <>\n        {!hasSidecarWorkloads\n          ? this.renderTooltip('tooltip_wizard_actions', TooltipPosition.top, toolTipMsgActions, dropdown)\n          : dropdown}\n        <ServiceWizard\n          show={this.state.showWizard}\n          type={this.state.wizardType}\n          update={this.state.updateWizard}\n          namespace={this.props.namespace}\n          serviceName={this.props.serviceName}\n          workloads={validWorkloads}\n          virtualServices={this.props.virtualServices}\n          destinationRules={this.props.destinationRules}\n          gateways={this.props.gateways}\n          peerAuthentications={this.props.peerAuthentications}\n          tlsStatus={this.props.tlsStatus}\n          onClose={this.onClose}\n        />\n        <Modal\n          isSmall={true}\n          title=\"Confirm Delete Traffic Routing ?\"\n          isOpen={this.state.showConfirmDelete}\n          onClose={this.hideConfirmDelete}\n          actions={[\n            <Button key=\"cancel\" variant=\"secondary\" onClick={this.hideConfirmDelete}>\n              Cancel\n            </Button>,\n            <Button key=\"confirm\" variant=\"danger\" onClick={this.onDelete}>\n              Delete\n            </Button>\n          ]}\n        >\n          {this.getDeleteMessage()}\n        </Modal>\n      </>\n    );\n  }\n}\n\nexport default ServiceWizardDropdown;\n"]},"metadata":{},"sourceType":"module"}